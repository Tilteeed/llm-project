---
# 0) Если GPU отключён — просто выходим
- name: GPU | Disabled, skip role
  ansible.builtin.debug:
    msg: "gpu_enabled=false, skipping GPU setup"
  when: not (gpu_enabled | default(false))

# 1) Установка драйвера NVIDIA (рекомендованный Ubuntu)
- name: GPU | Install recommended NVIDIA driver
  ansible.builtin.command: ubuntu-drivers install
  register: driver_install
  changed_when: "'is already installed' not in driver_install.stdout"
  when: gpu_enabled | default(false)

# 2) Перезагрузка нужна только если драйвер реально установился/изменился
- name: GPU | Reboot if driver changed
  ansible.builtin.reboot:
    reboot_timeout: 900
  when: (gpu_enabled | default(false)) and (driver_install is changed)

# 3) Проверяем что GPU на хосте виден (на локальной VM без GPU тут и будет проблема,
# поэтому роль должна быть отключена через gpu_enabled=false)
- name: GPU | Check nvidia-smi on host
  ansible.builtin.command: nvidia-smi
  register: nvidia_smi
  changed_when: false
  when: gpu_enabled | default(false)

- name: GPU | Show GPU info
  ansible.builtin.debug:
    var: nvidia_smi.stdout_lines
  when: gpu_enabled | default(false)

# 4) Добавляем репозиторий NVIDIA Container Toolkit (1 раз)
- name: GPU | Add NVIDIA container toolkit repo (once)
  ansible.builtin.shell: |
    set -e
    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey \
      | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
    curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list \
      | sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' \
      > /etc/apt/sources.list.d/nvidia-container-toolkit.list
    apt-get update -y
  args:
    creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list
  when: gpu_enabled | default(false)

# 5) Ставим toolkit
- name: GPU | Install nvidia-container-toolkit
  ansible.builtin.apt:
    name: nvidia-container-toolkit
    state: present
  when: gpu_enabled | default(false)

# 6) Настраиваем Docker runtime для NVIDIA
- name: GPU | Configure Docker for NVIDIA
  ansible.builtin.command: nvidia-ctk runtime configure --runtime=docker
  register: ctk_config
  changed_when: true
  when: gpu_enabled | default(false)

# 7) Рестарт Docker (после настройки runtime)
- name: GPU | Restart Docker
  ansible.builtin.service:
    name: docker
    state: restarted
  when: (gpu_enabled | default(false)) and (ctk_config is changed)
